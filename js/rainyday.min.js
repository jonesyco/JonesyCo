function RainyDay(d,a){if(this===window){return new RainyDay(d)}this.img=d.image;var b={opacity:1,blur:10,crop:[0,0,this.img.naturalWidth,this.img.naturalHeight],enableSizeChange:true,parentElement:document.getElementsByTagName("body")[0],fps:30,fillStyle:"#8ED6FF",enableCollisions:true,gravityThreshold:3,gravityAngle:Math.PI/2,gravityAngleVariance:0,reflectionScaledownFactor:5,reflectionDropMappingWidth:200,reflectionDropMappingHeight:200,width:this.img.clientWidth,height:this.img.clientHeight,position:"absolute",top:0,left:0,zIndex:-1};for(var c in b){if(typeof d[c]==="undefined"){d[c]=b[c]}}this.options=d;this.drops=[];this.canvas=a||this.prepareCanvas();this.prepareBackground();this.prepareGlass();this.reflection=this.REFLECTION_MINIATURE;this.trail=this.TRAIL_DROPS;this.gravity=this.GRAVITY_NON_LINEAR;this.collision=this.COLLISION_SIMPLE;this.setRequestAnimFrame()}RainyDay.prototype.prepareCanvas=function(){var a=document.createElement("canvas");a.setAttribute("id","raincanvas");a.style.position=this.options.position;a.style.top=this.options.top;a.style.left=this.options.left;a.style.zIndex="-1";a.width=this.options.width;a.height=this.options.height;this.options.parentElement.appendChild(a);if(this.options.enableSizeChange){this.setResizeHandler()}return a};RainyDay.prototype.setResizeHandler=function(){if(window.onresize!==null){window.setInterval(this.checkSize.bind(this),100)}else{window.onresize=this.checkSize.bind(this);window.onorientationchange=this.checkSize.bind(this)}};RainyDay.prototype.checkSize=function(){var h=this.img.clientWidth;var e=this.img.clientHeight;var f=this.img.offsetLeft;var g=this.img.offsetTop;var d=this.canvas.width;var a=this.canvas.height;var b=this.canvas.offsetLeft;var c=this.canvas.offsetTop;if(d!==h||a!==e){this.canvas.width=h;this.canvas.height=e;this.prepareBackground();this.glass.width=this.canvas.width;this.glass.height=this.canvas.height;this.prepareReflections()}if(b!==f||c!==g){this.canvas.offsetLeft=f;this.canvas.offsetTop=g}};RainyDay.prototype.animateDrops=function(){if(this.addDropCallback){this.addDropCallback()}var a=this.drops.slice();var c=[];for(var b=0;b<a.length;++b){if(a[b].animate()){c.push(a[b])}}this.drops=c;window.requestAnimFrame(this.animateDrops.bind(this))};RainyDay.prototype.setRequestAnimFrame=function(){var a=this.options.fps;window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(b){window.setTimeout(b,1000/a)}})()};RainyDay.prototype.prepareReflections=function(){this.reflected=document.createElement("canvas");this.reflected.width=this.canvas.width/this.options.reflectionScaledownFactor;this.reflected.height=this.canvas.height/this.options.reflectionScaledownFactor;var a=this.reflected.getContext("2d");a.drawImage(this.img,this.options.crop[0],this.options.crop[1],this.options.crop[2],this.options.crop[3],0,0,this.reflected.width,this.reflected.height)};RainyDay.prototype.prepareGlass=function(){this.glass=document.createElement("canvas");this.glass.width=this.canvas.width;this.glass.height=this.canvas.height;this.context=this.glass.getContext("2d")};RainyDay.prototype.rain=function(f,g){if(this.reflection!==this.REFLECTION_NONE){this.prepareReflections()}this.animateDrops();this.presets=f;this.PRIVATE_GRAVITY_FORCE_FACTOR_Y=(this.options.fps*0.001)/25;this.PRIVATE_GRAVITY_FORCE_FACTOR_X=((Math.PI/2)-this.options.gravityAngle)*(this.options.fps*0.001)/50;if(this.options.enableCollisions){var c=0;for(var a=0;a<f.length;a++){if(f[a][0]+f[a][1]>c){c=Math.floor(f[a][0]+f[a][1])}}if(c>0){var e=Math.ceil(this.canvas.width/c);var d=Math.ceil(this.canvas.height/c);this.matrix=new CollisionMatrix(e,d,c)}else{this.options.enableCollisions=false}}for(var a=0;a<f.length;a++){if(!f[a][3]){f[a][3]=-1}}var b=0;this.addDropCallback=function(){var l=new Date().getTime();if(l-b<g){return}b=l;var h=this.canvas.getContext("2d");h.clearRect(0,0,this.canvas.width,this.canvas.height);h.drawImage(this.background,0,0,this.canvas.width,this.canvas.height);var k;for(var j=0;j<f.length;j++){if(f[j][2]>1||f[j][3]===-1){if(f[j][3]!==0){f[j][3]--;for(var m=0;m<f[j][2];++m){this.putDrop(new Drop(this,Math.random()*this.canvas.width,Math.random()*this.canvas.height,f[j][0],f[j][1]))}}}else{if(Math.random()<f[j][2]){k=f[j];break}}}if(k){this.putDrop(new Drop(this,Math.random()*this.canvas.width,Math.random()*this.canvas.height,k[0],k[1]))}h.save();h.globalAlpha=this.options.opacity;h.drawImage(this.glass,0,0,this.canvas.width,this.canvas.height);h.restore()}.bind(this)};RainyDay.prototype.putDrop=function(a){a.draw();if(this.gravity&&a.r>this.options.gravityThreshold){if(this.options.enableCollisions){this.matrix.update(a)}this.drops.push(a)}};RainyDay.prototype.clearDrop=function(a,b){var d=a.clear(b);if(d){var c=this.drops.indexOf(a);if(c>=0){this.drops.splice(c,1)}}return d};function Drop(e,b,c,d,a){this.x=Math.floor(b);this.y=Math.floor(c);this.r=(Math.random()*a)+d;this.rainyday=e;this.context=e.context;this.reflection=e.reflected}Drop.prototype.draw=function(){this.context.save();this.context.beginPath();var b=this.r;this.r=0.95*this.r;if(this.r<3){this.context.arc(this.x,this.y,this.r,0,Math.PI*2,true);this.context.closePath()}else{if(this.colliding||this.yspeed>2){if(this.colliding){var a=this.colliding;this.r=1.001*(this.r>a.r?this.r:a.r);this.x+=(a.x-this.x);this.colliding=null}var c=1+0.1*this.yspeed;this.context.moveTo(this.x-this.r/c,this.y);this.context.bezierCurveTo(this.x-this.r,this.y-this.r*2,this.x+this.r,this.y-this.r*2,this.x+this.r/c,this.y);this.context.bezierCurveTo(this.x+this.r,this.y+c*this.r,this.x-this.r,this.y+c*this.r,this.x-this.r/c,this.y)}else{this.context.arc(this.x,this.y,this.r*0.9,0,Math.PI*2,true);this.context.closePath()}}this.context.clip();this.r=b;if(this.rainyday.reflection){this.rainyday.reflection(this)}this.context.restore()};Drop.prototype.clear=function(a){this.context.clearRect(this.x-this.r-1,this.y-this.r-2,2*this.r+2,2*this.r+2);if(a){this.terminate=true;return true}if((this.y-this.r>this.rainyday.h)||(this.x-this.r>this.rainyday.w)||(this.x+this.r<0)){return true}return false};Drop.prototype.animate=function(){if(this.terminate){return false}var b=this.rainyday.gravity(this);if(!b&&this.rainyday.trail){this.rainyday.trail(this)}if(this.rainyday.options.enableCollisions){var a=this.rainyday.matrix.update(this,b);if(a){this.rainyday.collision(this,a)}}return !b||this.terminate};RainyDay.prototype.TRAIL_NONE=function(){};RainyDay.prototype.TRAIL_DROPS=function(a){if(!a.trailY||a.y-a.trailY>=Math.random()*100*a.r){a.trailY=a.y;this.putDrop(new Drop(this,a.x+(Math.random()*2-1)*Math.random(),a.y-a.r-5,Math.ceil(a.r/5),0))}};RainyDay.prototype.TRAIL_SMUDGE=function(a){var c=a.y-a.r-3;var b=a.x-a.r/2+(Math.random()*2);if(c<0||b<0){return}this.context.drawImage(this.clearbackground,b,c,a.r,2,b,c,a.r,2)};RainyDay.prototype.GRAVITY_NONE=function(){return true};RainyDay.prototype.GRAVITY_LINEAR=function(a){if(this.clearDrop(a)){return true}if(a.yspeed){a.yspeed+=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y*Math.floor(a.r);a.xspeed+=this.PRIVATE_GRAVITY_FORCE_FACTOR_X*Math.floor(a.r)}else{a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}a.y+=a.yspeed;a.draw();return false};RainyDay.prototype.GRAVITY_NON_LINEAR=function(a){if(this.clearDrop(a)){return true}if(a.collided){a.collided=false;a.seed=Math.floor(a.r*Math.random()*this.options.fps);a.skipping=false;a.slowing=false}else{if(!a.seed||a.seed<0){a.seed=Math.floor(a.r*Math.random()*this.options.fps);a.skipping=a.skipping===false?true:false;a.slowing=true}}a.seed--;if(a.yspeed){if(a.slowing){a.yspeed/=1.1;a.xspeed/=1.1;if(a.yspeed<this.PRIVATE_GRAVITY_FORCE_FACTOR_Y){a.slowing=false}}else{if(a.skipping){a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}else{a.yspeed+=1*this.PRIVATE_GRAVITY_FORCE_FACTOR_Y*Math.floor(a.r);a.xspeed+=1*this.PRIVATE_GRAVITY_FORCE_FACTOR_X*Math.floor(a.r)}}}else{a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}if(this.options.gravityAngleVariance!==0){a.xspeed+=((Math.random()*2-1)*a.yspeed*this.options.gravityAngleVariance)}a.y+=a.yspeed;a.x+=a.xspeed;a.draw();return false};RainyDay.prototype.positiveMin=function(b,c){var a=0;if(b<c){if(b<=0){a=c}else{a=b}}else{if(c<=0){a=b}else{a=c}}return a<=0?1:a};RainyDay.prototype.REFLECTION_NONE=function(){this.context.fillStyle=this.options.fillStyle;this.context.fill()};RainyDay.prototype.REFLECTION_MINIATURE=function(a){var f=Math.max((a.x-this.options.reflectionDropMappingWidth)/this.options.reflectionScaledownFactor,0);var g=Math.max((a.y-this.options.reflectionDropMappingHeight)/this.options.reflectionScaledownFactor,0);var e=this.positiveMin(this.options.reflectionDropMappingWidth*2/this.options.reflectionScaledownFactor,this.reflected.width-f);var d=this.positiveMin(this.options.reflectionDropMappingHeight*2/this.options.reflectionScaledownFactor,this.reflected.height-g);var b=Math.max(a.x-1.1*a.r,0);var c=Math.max(a.y-1.1*a.r,0);this.context.drawImage(this.reflected,f,g,e,d,b,c,a.r*2,a.r*2)};RainyDay.prototype.COLLISION_SIMPLE=function(b,a){var e=a;var c;while(e!=null){var g=e.drop;if(Math.sqrt(Math.pow(b.x-g.x,2)+Math.pow(b.y-g.y,2))<(b.r+g.r)){c=g;break}e=e.next}if(!c){return}var d,f;if(b.y>c.y){d=b;f=c}else{d=c;f=b}this.clearDrop(f);this.clearDrop(d,true);this.matrix.remove(d);f.draw();f.colliding=d;f.collided=true};RainyDay.prototype.prepareBackground=function(){this.background=document.createElement("canvas");this.background.width=this.canvas.width;this.background.height=this.canvas.height;this.clearbackground=document.createElement("canvas");this.clearbackground.width=this.canvas.width;this.clearbackground.height=this.canvas.height;var a=this.background.getContext("2d");a.clearRect(0,0,this.canvas.width,this.canvas.height);a.drawImage(this.img,this.options.crop[0],this.options.crop[1],this.options.crop[2],this.options.crop[3],0,0,this.canvas.width,this.canvas.height);a=this.clearbackground.getContext("2d");a.clearRect(0,0,this.canvas.width,this.canvas.height);a.drawImage(this.img,this.options.crop[0],this.options.crop[1],this.options.crop[2],this.options.crop[3],0,0,this.canvas.width,this.canvas.height);if(!isNaN(this.options.blur)&&this.options.blur>=1){this.stackBlurCanvasRGB(this.canvas.width,this.canvas.height,this.options.blur)}};RainyDay.prototype.stackBlurCanvasRGB=function(K,h,t){var C=[[0,9],[1,11],[2,12],[3,13],[5,14],[7,15],[11,16],[15,17],[22,18],[31,19],[45,20],[63,21],[90,22],[127,23],[181,24]];var m=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];t|=0;var d=this.background.getContext("2d");var k=d.getImageData(0,0,K,h);var r=k.data;var L,M,j,n,O,N,P,A,g,c,z,f,b,w,e,a,s,q,o,v;var u=t+1;var J=u*(u+1)/2;var I=new BlurStack();var F=new BlurStack();var E=I;for(j=1;j<2*t+1;j++){E=E.next=new BlurStack();if(j===u){F=E}}E.next=I;var G=null;var H=null;P=N=0;var l=m[t];var B;for(var D=0;D<C.length;++D){if(t<=C[D][0]){B=C[D-1][1];break}}for(M=0;M<h;M++){w=e=a=A=g=c=0;z=u*(s=r[N]);f=u*(q=r[N+1]);b=u*(o=r[N+2]);A+=J*s;g+=J*q;c+=J*o;E=I;for(j=0;j<u;j++){E.r=s;E.g=q;E.b=o;E=E.next}for(j=1;j<u;j++){n=N+((K-1<j?K-1:j)<<2);A+=(E.r=(s=r[n]))*(v=u-j);g+=(E.g=(q=r[n+1]))*v;c+=(E.b=(o=r[n+2]))*v;w+=s;e+=q;a+=o;E=E.next}G=I;H=F;for(L=0;L<K;L++){r[N]=(A*l)>>B;r[N+1]=(g*l)>>B;r[N+2]=(c*l)>>B;A-=z;g-=f;c-=b;z-=G.r;f-=G.g;b-=G.b;n=(P+((n=L+t+1)<(K-1)?n:(K-1)))<<2;w+=(G.r=r[n]);e+=(G.g=r[n+1]);a+=(G.b=r[n+2]);A+=w;g+=e;c+=a;G=G.next;z+=(s=H.r);f+=(q=H.g);b+=(o=H.b);w-=s;e-=q;a-=o;H=H.next;N+=4}P+=K}for(L=0;L<K;L++){e=a=w=g=c=A=0;N=L<<2;z=u*(s=r[N]);f=u*(q=r[N+1]);b=u*(o=r[N+2]);A+=J*s;g+=J*q;c+=J*o;E=I;for(j=0;j<u;j++){E.r=s;E.g=q;E.b=o;E=E.next}O=K;for(j=1;j<u;j++){N=(O+L)<<2;A+=(E.r=(s=r[N]))*(v=u-j);g+=(E.g=(q=r[N+1]))*v;c+=(E.b=(o=r[N+2]))*v;w+=s;e+=q;a+=o;E=E.next;if(j<(h-1)){O+=K}}N=L;G=I;H=F;for(M=0;M<h;M++){n=N<<2;r[n]=(A*l)>>B;r[n+1]=(g*l)>>B;r[n+2]=(c*l)>>B;A-=z;g-=f;c-=b;z-=G.r;f-=G.g;b-=G.b;n=(L+(((n=M+u)<(h-1)?n:(h-1))*K))<<2;A+=(w+=(G.r=r[n]));g+=(e+=(G.g=r[n+1]));c+=(a+=(G.b=r[n+2]));G=G.next;z+=(s=H.r);f+=(q=H.g);b+=(o=H.b);w-=s;e-=q;a-=o;H=H.next;N+=K}}d.putImageData(k,0,0)};function BlurStack(){this.r=0;this.g=0;this.b=0;this.next=null}function CollisionMatrix(d,e,c){this.resolution=c;this.xc=d;this.yc=e;this.matrix=new Array(d);for(var a=0;a<=(d+5);a++){this.matrix[a]=new Array(e);for(var b=0;b<=(e+5);++b){this.matrix[a][b]=new DropItem(null)}}}CollisionMatrix.prototype.update=function(b,c){if(b.gid){if(!this.matrix[b.gmx]||!this.matrix[b.gmx][b.gmy]){return null}this.matrix[b.gmx][b.gmy].remove(b);if(c){return null}b.gmx=Math.floor(b.x/this.resolution);b.gmy=Math.floor(b.y/this.resolution);if(!this.matrix[b.gmx]||!this.matrix[b.gmx][b.gmy]){return null}this.matrix[b.gmx][b.gmy].add(b);var a=this.collisions(b);if(a&&a.next!=null){return a.next}}else{b.gid=Math.random().toString(36).substr(2,9);b.gmx=Math.floor(b.x/this.resolution);b.gmy=Math.floor(b.y/this.resolution);if(!this.matrix[b.gmx]||!this.matrix[b.gmx][b.gmy]){return null}this.matrix[b.gmx][b.gmy].add(b)}return null};CollisionMatrix.prototype.collisions=function(a){var c=new DropItem(null);var b=c;c=this.addAll(c,a.gmx-1,a.gmy+1);c=this.addAll(c,a.gmx,a.gmy+1);c=this.addAll(c,a.gmx+1,a.gmy+1);return b};CollisionMatrix.prototype.addAll=function(b,c,d){if(c>0&&d>0&&c<this.xc&&d<this.yc){var a=this.matrix[c][d];while(a.next!=null){a=a.next;b.next=new DropItem(a.drop);b=b.next}}return b};CollisionMatrix.prototype.remove=function(a){this.matrix[a.gmx][a.gmy].remove(a)};function DropItem(a){this.drop=a;this.next=null}DropItem.prototype.add=function(a){var b=this;while(b.next!=null){b=b.next}b.next=new DropItem(a)};DropItem.prototype.remove=function(a){var b=this;var c=null;while(b.next!=null){c=b;b=b.next;if(b.drop.gid===a.gid){c.next=b.next}}};